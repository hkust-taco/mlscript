class Some[A]: { value: A }
class None: {}
//│ Defined class Some
//│ Defined class None



def flatMap3 = fun f -> fun opt -> case opt of { Some -> f opt | _ -> opt }
//│ flatMap3: ('a -> 'b) -> ((some & 'a) | ('c & ~some)) -> 'b | 'c


def arg = if true then Some{value = 42} with {payload = 23} else None {}
//│ arg: (some & {value: 42} with {payload: 23}) | none

flatMap3 (fun x -> add x.value x.payload) arg
//│ /!!!\ Uncaught error: java.lang.StackOverflowError
//│ 	at: mlscript.TyperDatatypes$PrimType.toString(TyperDatatypes.scala:152)
//│ 	at: java.lang.String.valueOf(String.java:2994)
//│ 	at: java.lang.StringBuilder.append(StringBuilder.java:131)
//│ 	at: mlscript.TyperDatatypes$RecordType.$anonfun$toString$4(TyperDatatypes.scala:61)
//│ 	at: scala.collection.immutable.List.map(List.scala:246)
//│ 	at: mlscript.TyperDatatypes$RecordType.toString(TyperDatatypes.scala:61)
//│ 	at: java.lang.String.valueOf(String.java:2994)
//│ 	at: java.lang.StringBuilder.append(StringBuilder.java:131)
//│ 	at: mlscript.TyperDatatypes$WithType.toString(TyperDatatypes.scala:104)
//│ 	at: java.lang.String.valueOf(String.java:2994)


def arg = if true then Some{value = 42} else None {}
//│ arg: (some & {value: 42}) | none

flatMap3 (fun x -> x.value) arg
//│ res: 42 | (none & ~{value: 42}) | (none & ~some) | ((some & {value: 42}) & ~{value: 42}) | (({value: 42} & some) & ~some)


def foo = flatMap3 (fun x -> x.value)
//│ foo: ((some & {value: 'a}) | ('b & ~some)) -> 'a | 'b

foo arg
//│ res: 42 | (none & ~{value: 42}) | (none & ~some) | ((some & {value: 42}) & ~{value: 42}) | (({value: 42} & some) & ~some)

foo 1
//│ res: nothing | (1 & ~{value: nothing}) | (1 & ~some)

def fn = foo None
//│ fn: nothing | ((anything -> none) & ~{value: nothing}) | ((anything -> none) & ~some)

// :d
fn{} // foo None {}
//│ res: none

// :d
foo (None{})
//│ res: nothing | (none & ~{value: nothing}) | (none & ~some)


fun f -> flatMap3 f arg
//│ res: ((none & ~((none & ~some) | (({value: 42} & some) & ~some) & ~some)) | ((some & {value: 42}) & ~((none & ~some) | (({value: 42} & some) & ~some) & ~some)) -> 'a) -> 'a | (none & ~some) | (({value: 42} & some) & ~some)




def foo = flatMap3 (fun x -> x)
//│ foo: ((some & 'a) | ('b & ~some)) -> 'a | 'b

foo 1
//│ res: (1 & ~((1 & ~some) & ~some)) | (1 & ~some)




def simpler = fun f -> case None{} of { Some -> f 1 | _ -> None{} }
//│ simpler: (1 -> 'a) -> 'a | none

def simpler = fun f -> fun opt -> case opt of { Some -> f opt | None -> opt }
//│ simpler: ('a -> 'b) -> ((some & 'a) | ((none & 'c) & ~some)) -> 'b | 'c

simpler (fun x -> x.value)
//│ res: ((some & {value: 'a}) | ((none & 'b) & ~some)) -> 'a | 'b

:e
res 1
//│ /!!!\ Uncaught error: java.lang.StackOverflowError
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$5(ConstraintSolver.scala:130)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:128)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:125)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$5(ConstraintSolver.scala:259)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:128)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:125)


def funny = fun f -> case f of { Some -> f f }
//│ funny: 'a & some & ('a -> 'b) -> 'b

