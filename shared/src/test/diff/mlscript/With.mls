
def rcd = { x = 1 }
//│ rcd: {x: 1}

rcd.x
//│ res: 1

rcd with { y = 2 }
//│ res: {x: 1} with {y: 2}

add res.x res.y
//│ /!!!\ Uncaught error: java.lang.StackOverflowError
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$5(ConstraintSolver.scala:130)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:128)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:125)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$5(ConstraintSolver.scala:257)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:128)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:125)

rcd with { x = "oops" }
//│ res: {x: 1} with {x: "oops"}

res.x
//│ /!!!\ Uncaught error: java.lang.StackOverflowError
//│ 	at: scala.collection.IterableOnceOps.addString(IterableOnce.scala:1182)
//│ 	at: scala.collection.IterableOnceOps.addString$(IterableOnce.scala:1179)
//│ 	at: scala.collection.AbstractIterable.addString(Iterable.scala:919)
//│ 	at: scala.collection.IterableOnceOps.mkString(IterableOnce.scala:1129)
//│ 	at: scala.collection.IterableOnceOps.mkString$(IterableOnce.scala:1127)
//│ 	at: scala.collection.AbstractIterable.mkString(Iterable.scala:919)
//│ 	at: scala.collection.IterableOnceOps.mkString(IterableOnce.scala:1142)
//│ 	at: scala.collection.IterableOnceOps.mkString$(IterableOnce.scala:1142)
//│ 	at: scala.collection.AbstractIterable.mkString(Iterable.scala:919)
//│ 	at: mlscript.TyperDatatypes$PrimType.toString(TyperDatatypes.scala:152)

id rcd with { x = "oops" }
//│ res: {x: 1} with {x: "oops"}

res.x
//│ /!!!\ Uncaught error: java.lang.StackOverflowError
//│ 	at: mlscript.TermImpl.toString$(helpers.scala:139)
//│ 	at: mlscript.Term.toString(syntax.scala:38)
//│ 	at: java.lang.String.valueOf(String.java:2994)
//│ 	at: java.lang.StringBuilder.append(StringBuilder.java:131)
//│ 	at: scala.collection.IterableOnceOps.addString(IterableOnce.scala:1184)
//│ 	at: scala.collection.IterableOnceOps.addString$(IterableOnce.scala:1179)
//│ 	at: scala.collection.AbstractIterable.addString(Iterable.scala:919)
//│ 	at: scala.collection.IterableOnceOps.mkString(IterableOnce.scala:1129)
//│ 	at: scala.collection.IterableOnceOps.mkString$(IterableOnce.scala:1127)
//│ 	at: scala.collection.AbstractIterable.mkString(Iterable.scala:919)


def rcd = { }
//│ rcd: anything

id rcd with { x = "oops" }
//│ res: anything with {x: "oops"}

res.x
//│ /!!!\ Uncaught error: java.lang.StackOverflowError
//│ 	at: mlscript.TermImpl.toString$(helpers.scala:139)
//│ 	at: mlscript.Term.toString(syntax.scala:38)
//│ 	at: java.lang.String.valueOf(String.java:2994)
//│ 	at: java.lang.StringBuilder.append(StringBuilder.java:131)
//│ 	at: scala.collection.IterableOnceOps.addString(IterableOnce.scala:1184)
//│ 	at: scala.collection.IterableOnceOps.addString$(IterableOnce.scala:1179)
//│ 	at: scala.collection.AbstractIterable.addString(Iterable.scala:919)
//│ 	at: scala.collection.IterableOnceOps.mkString(IterableOnce.scala:1129)
//│ 	at: scala.collection.IterableOnceOps.mkString$(IterableOnce.scala:1127)
//│ 	at: scala.collection.AbstractIterable.mkString(Iterable.scala:919)


def f r = r with { x = "oops" }
//│ f: 'a -> ('a with {x: "oops"})

f rcd
//│ res: anything with {x: "oops"}

f (rcd with { y = 2 })
//│ res: anything with {y: 2} with {x: "oops"}


def f a b = if true then a else b
//│ f: 'a -> 'a -> 'a

def f a b = (if true then a else b) with { x = "oops" }
//│ f: 'a -> 'a -> ('a with {x: "oops"})

def f a b = let tmp = a.x in (if true then a else b) with { x = "oops" }
//│ f: 'a & {x: anything} -> 'a -> ('a with {x: "oops"})


({ name = "Bob" } with { age = 123 }).age
//│ res: 123

({ name = "Bob" } with { age = 123 }).name
//│ res: "Bob"

({ name = "Bob" } with { name = 123 }).name
//│ res: 123

